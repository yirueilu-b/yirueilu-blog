{"componentChunkName":"component---src-templates-post-js","path":"/blog/12b9fd","result":{"pageContext":{"md_path":"lineBotWeather","title":"Build a Line Bot With Flask for Weather Forecast","description":"There are already a number of tutorials about how to build a LINE chat bot with Python Flask and how to deploy the APP to Heroku (check References sec...","image":"https://i.imgur.com/b1rTt6Am.png","uuid":"12b9fd","text":"# Build a Line Bot With Flask for Weather Forecast\n\nThere are already a number of tutorials about how to build a LINE chat bot with Python Flask and how to deploy the APP to Heroku (check References section below) but few of them mention about the implementation details such as customized rich menu and reply messages. I followed those tutorials to built a simple bot with weather forecasting. After reading the tutorials and the official API documents, I successfully create hierarchical rich menus and flex messages as weather card.\n\n## Result Preview\n- Hierarchical Rich Menu    \n    ![](https://i.imgur.com/b1rTt6Am.png)![](https://i.imgur.com/4Fc6wg1m.png)\n- Weeakly Weather forecast for City     \n    ![](https://i.imgur.com/NH5m7bum.png)![](https://i.imgur.com/Z0Y0zaRm.png)![](https://i.imgur.com/YTHnAvlm.jpg)\n- Current Weather Report fot District   \n    ![](https://i.imgur.com/R0Wdbcwm.jpg)![](https://i.imgur.com/4ctVEoWm.png)\n\n\n## Weather API\n\nAfter finishing the tutorials about how to building a flask backend server and deploy to Heroku for LINE chat bot, the next step is to obtain the weather forecast information.\n\nTaiwan Central Weather Bureau (CWB) has already built great resources which is [Open Weather Data](https://opendata.cwb.gov.tw/index) for developers. There are comprehensive [API documents and examples](https://opendata.cwb.gov.tw/dist/opendata-swagger.html) for obtaining weather data, just sign up as a member then we could access those weather data for free\n\nThe below code is a small part of my code for obtaining weekly weather forecast, we could formulate the response information depending on how we want to show the information. I extract the descriptions of weather and clean up them as several lines in a list here.\n\n```python\ndef city_weather_forecast_week(city_name, key):\n    # obtain data\n    url = \"https://opendata.cwb.gov.tw/api/v1/rest/datastore/F-D0047-091?\"\n    url += \"Authorization=\" + key\n    url += \"&locationName=\" + city_name\n    response = requests.get(url)\n    report = json.loads(response.text)\n    data = report['records']['locations'][0]['location'][0]['weatherElement']\n    # parse weather description\n    description = [x for x in data if x['elementName'] == 'WeatherDescription'][0]['time']\n    description = [x['elementValue'][0]['value'] for x in description]\n    temp_description = []\n    for line in description:\n        line = line.split('。')[:-1]\n        # print(line)\n        winds = line[-2].split(' ')\n        if len(winds) > 2:\n            winds = winds[:1] + [winds[1] + winds[2]]\n        if \"降雨\" not in line[1]:\n            temp = '降雨機率 ??%'\n            line = [line[0], temp] + line[1:-2] + winds + line[-1:]\n        else:\n            line = line[:-2] + winds + line[-1:]\n        temp_description.append(line)\n    description = temp_description\n    # parse corresponding time of weather description\n    time = [x for x in data if x['elementName'] == 'T'][0]['time']\n    time = [x['startTime'].replace('-', '/')[:-3] for x in time]\n    # combine as result\n    result = []\n    if int(time[0].split(' ')[-1].split(':')[0]) < 18:\n        day_night = ['早', '晚']\n    else:\n        day_night = ['晚', '早']\n    for i in range(len(time)):\n        start_weekday = ' ' + DAY_NAME[datetime.datetime.strptime(time[i].split(' ')[0], '%Y/%m/%d').weekday()] + ' '\n        start_time = time[i].replace(' ', start_weekday)\n        temp = [start_time[5:-5], day_night[i % 2]]\n        temp.extend(description[i])\n        result.append(temp)\n    return result\n```\n\n## Line Rich Menu\n\nNext up is to create a rich menu for users so that they could simply press buttons to recieve the weather information.\n\nMy first attempt is to create a rich menu by following [the steps here](https://developers.line.biz/en/docs/messaging-api/using-rich-menus/#creating-a-rich-menu-using-the-messaging-api). It is super simple and just takes 4 steps to create a menu.\n\n- Setup the areas (layout) and define the action for each area in a json file\n- Upload the json file to LINE to create a rich menu\n- Upload the correspoding background image for the rich menu\n- Set the default menu by the rich menu ID\n\nAfter successfully create one, I was wondering if it possible to create a menu with mltiple pages i.e. a hierarchical one. I read the documents carefully and found that one menu with multiple pages not valid. Instead of creating one menu with pages, we should create several menus and link menu to user to achieve a hierarchical-like menu i.e. use `PostbackAction` in menu and call `set_default_menu_user` once server receive the post request.\n\n```python\nfrom linebot.models.rich_menu import RichMenu, RichMenuSize, RichMenuArea, RichMenuBounds\nfrom linebot.models.actions import *\n\n\n# 2 rows 3 cols\nclass MainMenu:\n    def __init__(self):\n        self.width = 800\n        self.height = 540\n        self.grid = (2, 3)\n        self.area1_1 = RichMenuArea(bounds=RichMenuBounds(x=0,\n                                                          y=0,\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=PostbackAction(label='go_weather_menu',\n                                                          data='{\"command\":\"go_weather_menu\"}'))\n        self.area1_2 = RichMenuArea(bounds=RichMenuBounds(x=self.width // self.grid[1],\n                                                          y=0,\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=URIAction(label='default',\n                                                     uri='https://yirueilu-b.github.io/YirueiLuBlogGatsby/'))\n        self.area1_3 = RichMenuArea(bounds=RichMenuBounds(x=self.height // self.grid[0] * 2,\n                                                          y=0,\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=URIAction(label='default',\n                                                     uri='https://yirueilu-b.github.io/YirueiLuBlogGatsby/'))\n        self.area2_1 = RichMenuArea(bounds=RichMenuBounds(x=0,\n                                                          y=self.height // self.grid[0],\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=URIAction(label='default',\n                                                     uri='https://yirueilu-b.github.io/YirueiLuBlogGatsby/'))\n        self.area2_2 = RichMenuArea(bounds=RichMenuBounds(x=self.height // self.grid[0],\n                                                          y=self.height // self.grid[0],\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=URIAction(label='default',\n                                                     uri='https://yirueilu-b.github.io/YirueiLuBlogGatsby/'))\n        self.area2_3 = RichMenuArea(bounds=RichMenuBounds(x=self.height // self.grid[0] * 2,\n                                                          y=self.height // self.grid[0],\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=URIAction(label='default',\n                                                     uri='https://yirueilu-b.github.io/YirueiLuBlogGatsby/'))\n        self.menu = self.create_menu()\n\n    def create_menu(self):\n        rich_menu_main = RichMenu(\n            size=RichMenuSize(width=self.width, height=self.height),\n            selected=False,\n            name=\"Main Menu\",\n            chat_bar_text=\"主選單\",\n            areas=[self.area1_1, self.area1_2, self.area1_3, self.area2_1, self.area2_2, self.area2_3]\n        )\n        return rich_menu_main\n\n\n# 2 rows 3 cols\nclass WeatherMenu:\n    def __init__(self):\n        self.width = 800\n        self.height = 540\n        self.grid = (2, 3)\n        self.area_back = RichMenuArea(bounds=RichMenuBounds(x=self.width // self.grid[1] * 2,\n                                                            y=0,\n                                                            width=self.width // self.grid[1],\n                                                            height=self.height),\n                                      action=PostbackAction(label='back_main_menu',\n                                                            data='{\"command\":\"back_main_menu\"}'))\n\n        self.area1_1 = RichMenuArea(bounds=RichMenuBounds(x=0,\n                                                          y=0,\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=PostbackAction(label='select_region',\n                                                          data='{\"command\":\"select_region\"}'))\n        self.area1_2 = RichMenuArea(bounds=RichMenuBounds(x=self.width // self.grid[1],\n                                                          y=0,\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=PostbackAction(label='share_loc_weather',\n                                                          data='{\"command\":\"share_loc_for_weather\"}'))\n        self.area1_3 = RichMenuArea(bounds=RichMenuBounds(x=0,\n                                                          y=self.height // self.grid[0],\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=MessageAction(label='weather', text='按鈕3'))\n        self.area1_4 = RichMenuArea(bounds=RichMenuBounds(x=self.width // self.grid[1],\n                                                          y=self.height // self.grid[0],\n                                                          width=self.width // self.grid[1],\n                                                          height=self.height // self.grid[0]),\n                                    action=MessageAction(label='weather', text='按鈕4'))\n\n        self.menu = self.create_menu()\n\n    def create_menu(self):\n        rich_menu_weather = RichMenu(\n            size=RichMenuSize(width=self.width, height=self.height),\n            selected=False,\n            name=\"Weather Menu\",\n            chat_bar_text=\"天氣查詢選單\",\n            areas=[self.area_back, self.area1_1, self.area1_2, self.area1_3, self.area1_4]\n        )\n        return rich_menu_weather\n\n```\n\n```python\n@handler.add(PostbackEvent)\ndef handle_postback(event):\n    post_data = json.loads(event.postback.data)\n    if post_data['command'] == 'go_weather_menu':\n        set_default_menu_user(rich_menu_data['weather_menu'], event.source.user_id)\n    elif post_data['command'] == 'back_main_menu':\n        set_default_menu_user(rich_menu_data['main_menu'], event.source.user_id)\n```\n\n## Flex Message\n\nLINE provides a super convenient tool called **Flex Message Simulator** for developers to design the layout of messages\n\n![](https://i.imgur.com/cnp6d0q.png)\n\nWith the Flex Message Simulator we could design some reply messages with fancy look. I first create a template on the simulator then reconstruct it and tear it into several parts in my code so that the layout could be more easy to be understood. Here is a example.\n\n```python\ndef current_weather_layout(result, datetime_now, area):\n    day_bg_image = \"https://i.imgur.com/ABDcFmel.png\"\n    night_bg_image = \"https://i.imgur.com/MTwqLasl.png\"\n    if 5 < int(datetime_now.split(' ')[1][:2]) < 18:\n        background_image = day_bg_image\n    else:\n        background_image = night_bg_image\n\n    background_image_layout = {\n        \"type\": \"image\",\n        \"url\": background_image,\n        \"aspectRatio\": \"4:3\",\n        \"size\": \"full\",\n        \"aspectMode\": \"cover\"\n    }\n    area_layout = {\n        \"type\": \"box\",\n        \"layout\": \"vertical\",\n        \"contents\": [\n            {\n                \"type\": \"text\",\n                \"text\": area,\n                \"size\": \"lg\",\n                \"weight\": \"bold\",\n                \"offsetTop\": \"10px\",\n                \"offsetStart\": \"20px\",\n                \"color\": text_color\n            }\n        ],\n        \"position\": \"absolute\",\n        \"width\": \"100%\",\n        \"height\": \"15%\",\n        \"offsetTop\": \"0px\",\n        \"backgroundColor\": \"#54545487\"\n    }\n    datetime_now_layout = {\n        \"type\": \"box\",\n        \"layout\": \"vertical\",\n        \"contents\": [\n            {\n                \"type\": \"text\",\n                \"text\": datetime_now,\n                \"size\": \"sm\",\n                \"offsetEnd\": \"20px\",\n                \"position\": \"absolute\",\n                \"offsetBottom\": \"10px\",\n                \"color\": text_color\n            }\n        ],\n        \"position\": \"absolute\",\n        \"width\": \"100%\",\n        \"height\": \"15%\",\n        \"offsetBottom\": \"0px\",\n    }\n\n    layout = {\n        \"type\": \"bubble\",\n        \"size\": \"giga\",\n        \"hero\": {\n            \"type\": \"box\",\n            \"layout\": \"vertical\",\n            \"contents\": [\n                background_image_layout,\n                area_layout,\n                datetime_now_layout, {\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"contents\": [\n                        current_weather_icon_layout(result),\n                        {\n                            \"type\": \"separator\",\n                            \"color\": \"#FFFFFF\"\n                        },\n                        current_weather_content_layout(result),\n                    ],\n                    \"position\": \"absolute\",\n                    \"width\": \"100%\",\n                    \"offsetBottom\": \"15%\",\n                },\n            ],\n            \"width\": \"100%\",\n            \"height\": \"100%\"\n        }\n    }\n    return layout\n\n\ndef current_weather_content_layout(res):\n    content_box = {\n        \"type\": \"box\",\n        \"layout\": \"vertical\",\n        \"contents\": [{\n            \"type\": \"text\",\n            \"text\": text,\n            \"color\": text_color,\n        } for text in res],\n        \"position\": \"relative\",\n        \"spacing\": \"6px\",\n        \"offsetStart\": \"20px\",\n    }\n    return content_box\n\n\ndef current_weather_icon_layout(res):\n    content_box = {\n        \"type\": \"box\",\n        \"layout\": \"vertical\",\n        \"contents\": [\n            {\n                \"type\": \"image\",\n                \"url\": get_weather_icon_url(res[0]),\n                \"aspectRatio\": \"1:1\",\n                \"size\": \"sm\"\n            },\n            {\n                \"type\": \"text\",\n                \"color\": \"#ffffffDE\",\n                \"size\": \"3xl\",\n                \"align\": \"center\",\n                \"text\": res[2][4:-1] + \"°C\",\n                \"style\": \"italic\",\n                \"offsetTop\": \"20px\"\n            }\n        ],\n        \"offsetTop\": \"0px\",\n        \"spacing\": \"7px\",\n        \"offsetStart\": \"0px\",\n        \"width\": \"35%\",\n        \"paddingAll\": \"10px\"\n    }\n    return content_box\n\n\ndef get_weather_icon_url(description):\n    \"\"\"\n    sunny https://i.imgur.com/UesuCsb.png\n    cloud https://i.imgur.com/LoX2DqF.png\n    rainy https://i.imgur.com/QY5Btv7.png\n    rainy https://i.imgur.com/vgkEB7P.png\n    rainy https://i.imgur.com/vetABf4.png\n    :param description:\n    :return:\n    \"\"\"\n    url = \"https://i.imgur.com/UesuCsb.png\"\n    conditions = ['晴', '雨', '雲', '陣雨']\n    converted_conditions = ''\n    for condition in conditions:\n        if condition in description:\n            converted_conditions += '1'\n        else:\n            converted_conditions += '0'\n    # sunny\n    if converted_conditions == '1000':\n        url = \"https://i.imgur.com/UesuCsb.png\"\n    # cloud\n    elif converted_conditions == '1010':\n        url = \"https://i.imgur.com/LoX2DqF.png\"\n    elif converted_conditions == '0010':\n        url = \"https://i.imgur.com/LoX2DqF.png\"\n    # rain\n    elif converted_conditions == '0100':\n        url = \"https://i.imgur.com/QY5Btv7.png\"\n    elif converted_conditions == '0110':\n        url = \"https://i.imgur.com/QY5Btv7.png\"\n    elif converted_conditions == '1100':\n        url = \"https://i.imgur.com/QY5Btv7.png\"\n    # hard rain\n    elif converted_conditions[-1] == '1':\n        url = \"https://i.imgur.com/vgkEB7P.png\"\n    # all\n    elif converted_conditions == '1110':\n        url = \"https://i.imgur.com/vetABf4.png\"\n    return url\n```\n\n## Location Action\n\nWhile writing the function for getting current weather report, I was struggling on how to access the location of user. It turns out that we could only use [location action](https://developers.line.biz/en/reference/messaging-api/#location-action) with [quick reply message](https://developers.line.biz/en/docs/messaging-api/using-quick-reply/). Here is the description from official document\n\n> **Location action**    \n> This action can be configured only with quick reply buttons. When a button associated with this action is tapped, the location screen in LINE is opened.\n\nTherefore the workflow for getting current weather report is like\n\n- User click the button for getting current weather report\n- Server ask user to share location with quick reply message\n- Server receive location message from user and call function to find the weather information\n- Sent a weather card back to user\n```python\nself.area1_2 = RichMenuArea(bounds=RichMenuBounds(x=self.width // self.grid[1],\n                                                  y=0,\n                                                  width=self.width // self.grid[1],\n                                                  height=self.height // self.grid[0]),\n                            action=PostbackAction(label='share_loc_weather',\n                                                  data='{\"command\":\"share_loc_for_weather\"}'))\n```\n```python\n@handler.add(MessageEvent, message=LocationMessage)\ndef handle_location_message(event):\n    # area = ['台北市', '大安區']\n    timestamp = event.timestamp\n    datetime_obj = datetime.datetime.fromtimestamp(timestamp / 1000)\n    datetime_obj = datetime_obj.astimezone(datetime.timezone(offset=datetime.timedelta(hours=8)))\n    lat = event.message.latitude\n    lon = event.message.longitude\n    area = crawler.decode_coordinate(lat, lon, google_key)\n    res = crawler.current_weather_report(area, datetime_obj, weather_key)\n    flex_message_current_weather = FlexSendMessage(\n        alt_text=''.join(area) + '目前天氣狀況',\n        contents=flex_layout.current_weather_layout(res, datetime_obj.strftime('%Y/%m/%d %H:%M'), '-'.join(area))\n    )\n    line_bot_api.reply_message(\n        event.reply_token,\n        flex_message_current_weather\n    )\n```\n\n## Note\n\n- The hierarchical menu seems not a proper design for LINE chat bot, the time cost of switching between pages is too much\n- Some attributes are not avalible in flex messages such as `alignItems` and `justifyContent`.\n- The location is converted to district and city name by [Google geocoding API](https://developers.google.com/maps/documentation/geocoding/start?utm_source=google&utm_medium=cpc&utm_campaign=FY18-Q2-global-demandgen-paidsearchonnetworkhouseads-cs-maps_contactsal_saf&utm_content=text-ad-none-none-DEV_c-CRE_396517150207-ADGP_Hybrid%20%7C%20AW%20SEM%20%7C%20BKWS%20~%20Places%20%7C%20EXA%20%7C%20Google%20Maps%20Geocoding%20API-KWID_43700049560642454-aud-563211326064%3Akwd-300650646186-userloc_9040379&utm_term=KW_google%20geocoding%20api-ST_google%20geocoding%20api&gclid=Cj0KCQjwxNT8BRD9ARIsAJ8S5xbxq8nR2F-ksLjIm9j-O-laigHvQkZmNZLIsXve2g3sKM7_7symfMwaAu4REALw_wcB)\n\n## References\n\n[LINE Developers](https://developers.line.biz/en/)\n\n[Heroku](https://dashboard.heroku.com/login)\n\n[twtrubiks/line-bot-tutorial](https://github.com/twtrubiks/line-bot-tutorial)\n\n[twtrubiks/Deploying-Flask-To-Heroku](https://github.com/twtrubiks/Deploying-Flask-To-Heroku)\n\n[twtrubiks/Flask-Migrate-Tutorial](https://github.com/twtrubiks/Flask-Migrate-Tutorial)\n\n[Python Flask 結合 Ngrok 架一個本地端的Https伺服器](https://xiaosean.github.io/server/2018-04-18-Flask_Ngrok/)\n\n[line/line-bot-sdk-python](https://github.com/line/line-bot-sdk-python)\n\n###### tags: `Blog`"}},"staticQueryHashes":[]}